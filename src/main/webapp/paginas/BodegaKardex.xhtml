<!DOCTYPE html>
<html lang="es"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="jakarta.faces.facelets"
      xmlns:f="jakarta.faces.core">

<h:head>
    <meta charset="UTF-8" />
    <title>#{bodegaKardexFrm.nombreBean}</title>
    <h:outputStylesheet library="estilos" name="disenoAlmacen.css" />
    <h:outputStylesheet library="primefaces" name="primeicons/primeicons.css" />
</h:head>

<h:body>

    <ui:include src="/WEB-INF/includes/topbar.xhtml" />

    <div class="page-container">
        <div class="container">
            <div class="header">
                <h1>#{bodegaKardexFrm.nombreBean}</h1>
            </div>

            <div class="content">

                <h:panelGroup id="pnlTabla" layout="block">

                    <h:form id="frmTop">

                        <!-- RemoteCommand ejecutado por WebSocket -->
                        <p:remoteCommand id="actualizarTablaCmd"
                                         name="actualizarTablaCmd"
                                         actionListener="#{bodegaKardexFrm.actualizarTabla}"
                                         update="tablaVentasFinalizadas,wsStatus"
                                         process="@this"
                                         async="false" />

                        <!-- Poll de respaldo (cada 2 seg si WebSocket falla) -->
                        <p:poll id="pollTabla"
                                interval="2"
                                listener="#{bodegaKardexFrm.actualizarTabla}"
                                update="tablaVentasFinalizadas,wsStatus"
                                global="false"
                                autoStart="true" />

                        <p:growl id="messages"
                                 showDetail="true"
                                 life="5000" />

                        <p:dataTable id="tablaVentasFinalizadas"
                                     value="#{bodegaKardexFrm.ventasFinalizadas}"
                                     var="venta"
                                     paginator="true"
                                     rows="10"
                                     paginatorPosition="bottom"
                                     rowHover="true"
                                     responsiveLayout="scroll"
                                     emptyMessage="No hay ventas finalizadas registradas"
                                     styleClass="tabla-general"
                                     stripedRows="true">

                            <f:facet name="header">
                                <span>Ventas con Estado FINALIZADA (Actualización en Tiempo Real)</span>
                            </f:facet>

                            <p:column headerText="ID Venta"
                                      sortBy="#{venta.id}"
                                      style="width:150px; text-align:left;">
                                <h:outputText value="#{venta.id}" />
                            </p:column>

                            <p:column headerText="Cliente"
                                      sortBy="#{venta.idCliente.nombre}">
                                <h:outputText value="#{venta.idCliente.nombre}" />
                            </p:column>

                            <p:column headerText="Estado"
                                      style="width:110px; text-align:center;">
                                <h:panelGroup style="color: #27ae60; font-weight: bold;">
                                    <i class="pi pi-check-circle"></i>
                                    <h:outputText value=" #{venta.estado}" />
                                </h:panelGroup>
                            </p:column>

                            <p:column headerText="Fecha"
                                      sortBy="#{venta.fecha}"
                                      style="width:150px; text-align:center;">
                                <h:outputText value="#{venta.fecha}">
                                    <f:convertDateTime type="localDateTime" pattern="dd/MM/yyyy HH:mm" />
                                </h:outputText>
                            </p:column>

                            <p:column headerText="Observaciones">
                                <h:outputText value="#{venta.observaciones}"
                                              rendered="#{not empty venta.observaciones}"
                                              title="#{venta.observaciones}" />
                                <h:outputText value="---"
                                              rendered="#{empty venta.observaciones}"
                                              style="color: #999;" />
                            </p:column>

                        </p:dataTable>

                    </h:form>
                </h:panelGroup>

                <h:panelGroup id="pnlDetalle" layout="block" style="margin-top: 20px; padding: 15px; background-color: #f5f5f5; border-radius: 5px;">
                    <h:form id="frmInfo">
                        <h:panelGrid columns="1" style="width: 100%;">
                            <h:outputText value="Estado WebSocket:" style="font-weight: bold; margin-bottom: 10px;" />
                            <h:outputText id="wsStatus"
                                          value="Conectando..."
                                          style="color: #f39c12; font-weight: bold;" />
                            <h:outputText value="✓ Actualizaciones en tiempo real activas"
                                          style="margin-top: 10px; font-size: 0.9em; color: #27ae60;" />
                        </h:panelGrid>
                    </h:form>
                </h:panelGroup>

            </div>
        </div>
    </div>

    <script>
        var ws = null;
        var reconnectAttempts = 0;
        var maxReconnectAttempts = 5;
        var reconnectDelay = 3000;

        function actualizarStatusWS(estado, color) {
            var statusElement = document.getElementById('frmInfo:wsStatus');
            if (statusElement) {
                statusElement.textContent = estado;
                statusElement.style.color = color;
            }
        }

        function conectarWebSocket() {
            try {
                var protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                var wsUrl = protocol + '//' + window.location.host + '#{request.contextPath}' + '/kardex';

                console.log("Conectando a: " + wsUrl);
                actualizarStatusWS("Conectando...", "#f39c12");

                ws = new WebSocket(wsUrl);

                ws.onopen = function() {
                    console.log("WebSocket conectado");
                    actualizarStatusWS("Conectado (tiempo real)", "#27ae60");
                    reconnectAttempts = 0;
                };

                ws.onmessage = function(event) {
                    console.log("Actualización recibida: " + event.data);
                    actualizarStatusWS("⟳ Actualizando...", "#3498db");

                    // Ejecutar el remoteCommand de JSF
                    if (typeof actualizarTablaCmd === 'function') {
                        actualizarTablaCmd();
                    }

                    setTimeout(function() {
                        actualizarStatusWS("✓ Conectado (tiempo real)", "#27ae60");
                    }, 800);
                };

                ws.onerror = function(error) {
                    console.error("Error WebSocket: " + error);
                    actualizarStatusWS("Error - usando poll", "#e67e22");
                };

                ws.onclose = function() {
                    console.log("WebSocket cerrado");
                    actualizarStatusWS("Reconectando...", "#e67e22");
                    intentarReconectar();
                };

            } catch (error) {
                console.error("✗ Error: " + error);
                intentarReconectar();
            }
        }

        function intentarReconectar() {
            if (reconnectAttempts &lt; maxReconnectAttempts) {
                reconnectAttempts++;
                console.log("Intento " + reconnectAttempts + "/" + maxReconnectAttempts);
                setTimeout(conectarWebSocket, reconnectDelay);
            } else {
                console.error("No se pudo conectar");
                actualizarStatusWS("WebSocket inactivo - usando polling", "#e74c3c");
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', conectarWebSocket);
        } else {
            conectarWebSocket();
        }

        window.addEventListener('online', function() {
            console.log("Conexión de red recuperada");
            if (ws === null || ws.readyState === WebSocket.CLOSED) {
                reconnectAttempts = 0;
                conectarWebSocket();
            }
        });
    </script>

</h:body>
</html>
