<!DOCTYPE html>
<html lang="es"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="jakarta.faces.html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="jakarta.faces.core">

<h:head>
    <meta charset="UTF-8"/>
    <title>#{tipoProductoFrm.nombreBean}</title>
    <h:outputStylesheet library="estilos" name="disenoAlmacen.css"/>
    <h:outputStylesheet library="primefaces" name="primeicons/primeicons.css"/>
</h:head>

<h:body>

    <!-- Topbar -->
    <h:form id="topbarForm">
        <p:menubar styleClass="topbar">
            <p:submenu label="Inventario" icon="pi pi-box">
                <p:menuitem value="Tipo Almacén" url="TipoAlmacen.jsf" icon="pi pi-building" />
                <p:menuitem value="Tipo Producto" url="TipoProducto.jsf" icon="pi pi-tags" />
                <p:menuitem value="Tipo Unidad Medida" url="TipoUnidadMedida.jsf" icon="pi pi-sliders-h" />
                <p:menuitem value="Característica" url="Caracteristica.jsf" icon="pi pi-list" />
                <p:menuitem value="TipoProducto-Característica" url="TipoProductoCaracteristica.jsf" icon="pi pi-link" />
                <p:menuitem value="Unidad Medida" url="UnidadMedida.jsf" icon="pi pi-sliders-h" />
            </p:submenu>
        </p:menubar>
    </h:form>

    <h1>#{tipoProductoFrm.nombreBean}</h1>

    <!-- Listado jerárquico -->
    <h:panelGroup id="pnlTabla">
        <h:form id="frmTop">
            <p:treeTable id="tabla-top"
                         rendered="#{tipoProductoFrm.estado.name() eq 'NADA'}"
                         value="#{tipoProductoFrm.root}"
                         var="n"
                         selectionMode="single"
                         selection="#{tipoProductoFrm.selectedNode}"
                         paginator="true"
                         rows="#{tipoProductoFrm.pageSize}"
                         paginatorPosition="bottom"
                         rowKey="#{n.id}">
                <p:ajax event="select" listener="#{tipoProductoFrm.onTreeRowSelect}" update=":pnlTabla :pnlDetalle :messages"/>
                <p:column headerText="Nombre" expander="true"><h:outputText value="#{n.nombre}" /></p:column>
                <p:column headerText="ID" style="width:110px"><h:outputText value="#{n.id}" /></p:column>
                <p:column headerText="Estado" style="width:120px"><h:outputText value="#{n.activo ? 'Activo' : 'Inactivo'}" /></p:column>
                <p:column headerText="Comentarios"><h:outputText value="#{n.comentarios}" /></p:column>
            </p:treeTable>

            <p:commandButton id="btnNuevo" value="Nuevo Tipo de Producto" styleClass="btn-rojo"
                             rendered="#{tipoProductoFrm.estado.name() eq 'NADA'}"
                             actionListener="#{tipoProductoFrm.btnNuevoHandler}"
                             process="@this" immediate="true"
                             update=":pnlDetalle :pnlTabla :messages"/>

            <p:commandButton id="btnCancelar" value="Cancelar Tipo de Producto" styleClass="btn-oscuro"
                             rendered="#{tipoProductoFrm.estado.name() ne 'NADA'}"
                             actionListener="#{tipoProductoFrm.btnCancelarHandler}"
                             process="@this" immediate="true"
                             update=":pnlDetalle :pnlTabla :messages"/>

            <p:growl id="messages" showDetail="true" life="5000" sticky="false" />
        </h:form>
    </h:panelGroup>

    <!-- Detalle con pestañas -->
    <h:panelGroup id="pnlDetalle">
        <h:form id="frmCrear" rendered="#{tipoProductoFrm.estado.name() ne 'NADA'}">
            <p:tabView>

                <!-- Generalidades -->
                <p:tab title="Generalidades" id="tabGeneralidades">
                    <p:panelGrid columns="2" styleClass="form-grid-2col" columnClasses="col-label,col-field">

                        <h:outputLabel for="txtIdPanel" value="ID:"/>
                        <h:panelGroup id="txtIdPanel">
                            <h:outputText rendered="#{empty tipoProductoFrm.registro.id}"
                                          value="(Se asignará automáticamente al guardar)"
                                          styleClass="id-info-text"/>
                            <h:inputText id="txtId" value="#{tipoProductoFrm.registro.id}"
                                         rendered="#{not empty tipoProductoFrm.registro.id}" disabled="true"/>
                        </h:panelGroup>

                        <h:outputLabel for="txtNombre" value="Nombre:"/>
                        <h:inputText id="txtNombre" value="#{tipoProductoFrm.registro.nombre}" styleClass="inp"/>

                        <h:outputLabel for="selPadre" value="Depende de:"/>
                        <p:selectOneMenu id="selPadre"
                                         value="#{tipoProductoFrm.padreSeleccionadoId}"
                                         styleClass="select-rojo-negro" style="min-width: 260px">
                            <f:selectItem itemLabel="— (raíz) —" itemValue="#{null}" noSelectionOption="true"/>
                            <f:selectItems value="#{tipoProductoFrm.opcionesPadreJerarquicas}"
                                           var="op" itemLabel="#{op.label}" itemValue="#{op.id}"/>
                        </p:selectOneMenu>

                        <h:outputLabel for="chkActivo" value="Activo:"/>
                        <h:selectBooleanCheckbox id="chkActivo" value="#{tipoProductoFrm.registro.activo}"/>

                        <h:outputLabel for="txtComentarios" value="Comentarios:"/>
                        <h:inputTextarea id="txtComentarios" value="#{tipoProductoFrm.registro.comentarios}" rows="3" styleClass="inp"/>
                    </p:panelGrid>

                    <p:panelGrid columns="3" style="margin-top: 15px;">
                        <p:commandButton value="Crear Tipo de Producto" styleClass="btn-rojo"
                                         actionListener="#{tipoProductoFrm.btnGuardarHandler}"
                                         rendered="#{tipoProductoFrm.estado.name() eq 'CREAR'}"
                                         update=":messages :pnlDetalle :pnlTabla" process="@form"/>
                        <p:commandButton value="Modificar Tipo de Producto" styleClass="btn-oscuro"
                                         actionListener="#{tipoProductoFrm.btnModificarHandler}"
                                         rendered="#{tipoProductoFrm.estado.name() eq 'MODIFICAR'}"
                                         update=":messages :pnlDetalle :pnlTabla" process="@form"/>
                        <p:commandButton value="Eliminar Tipo de Producto" styleClass="btn-rojo"
                                         actionListener="#{tipoProductoFrm.btnEliminarHandler}"
                                         rendered="#{tipoProductoFrm.estado.name() eq 'MODIFICAR'}"
                                         update=":messages :pnlDetalle :pnlTabla"/>
                    </p:panelGrid>
                </p:tab>

                <!-- Características -->
                <p:tab title="Características" id="tabCar">
                    <p:panelGrid columns="1" styleClass="form-grid-2col" columnClasses="col-field">

                        <!-- Tabla de asociaciones existentes -->
                        <p:dataTable id="tabla-top"
                                     lazy="true"
                                     rendered="#{tipoProductoCaracteristicaFrm.estado == 'NADA'}"
                                     rows="#{tipoProductoCaracteristicaFrm.pageSize}"
                                     paginator="true"
                                     paginatorPosition="bottom"
                                     value="#{tipoProductoCaracteristicaFrm.modelo}"
                                     var="reg"
                                     selectionMode="single"
                                     selection="#{tipoProductoCaracteristicaFrm.registro}"
                                     rowKey="#{reg.id}">
                            <p:ajax event="rowSelect"
                                    listener="#{tipoProductoCaracteristicaFrm.selectionHandler}"
                                    update=":pnlTabla :pnlDetalle"/>
                            <p:column headerText="ID"><h:outputText value="#{reg.id}" /></p:column>
                            <p:column headerText="Tipo Producto">
                                <h:outputText value="#{reg.idTipoProducto != null ? reg.idTipoProducto.nombre : '-'}" />
                            </p:column>
                            <p:column headerText="Característica">
                                <h:outputText value="#{reg.idCaracteristica != null ? reg.idCaracteristica.nombre : '-'}" />
                            </p:column>
                            <p:column headerText="Obligatorio"><h:outputText value="#{reg.obligatorio ? 'Sí' : 'No'}"/></p:column>
                            <p:column headerText="Fecha creación"><h:outputText value="#{reg.fechaCreacion}" /></p:column>
                        </p:dataTable>

                        <!-- Botones arriba del formulario -->
                        <div style="display:flex; gap:10px; margin-top:10px;">
                            <p:commandButton id="btnNuevo" value="Nueva Caracteristica" styleClass="btn-rojo"
                                             rendered="#{tipoProductoCaracteristicaFrm.estado == 'NADA'}"
                                             actionListener="#{tipoProductoCaracteristicaFrm.btnNuevoHandler}" update=":pnlDetalle :pnlTabla"/>

                            <p:commandButton id="btnCancelar" value="Cancelar Caracteristica" styleClass="btn-oscuro"
                                             rendered="#{tipoProductoCaracteristicaFrm.estado != 'NADA'}"
                                             actionListener="#{tipoProductoCaracteristicaFrm.btnCancelarHandler}" update=":pnlDetalle :pnlTabla"/>

                            <p:commandButton id="btnEliminar" value="Eliminar Caracteristica" styleClass="btn-rojo"
                                             rendered="#{tipoProductoCaracteristicaFrm.estado == 'MODIFICAR'}"
                                             actionListener="#{tipoProductoCaracteristicaFrm.btnEliminarHandler}"
                                             update=":messages :pnlDetalle :pnlTabla"
                                             process="@this"/>
                        </div>

                        <!-- Formulario de asociación (TODO DENTRO y con rendered) -->
                        <h:panelGrid columns="2"
                                     rendered="#{tipoProductoCaracteristicaFrm.estado != 'NADA'}"
                                     style="margin-top:12px">

                            <h:outputLabel for="txtTPCId" value="ID:"/>
                            <h:inputText id="txtTPCId" value="#{tipoProductoFrm.tpcRegistro.id}" disabled="true"/>

                            <h:outputLabel for="txtCarNom" value="Característica:"/>
                            <h:panelGroup>
                                <h:inputText id="txtCarNom"
                                             value="#{tipoProductoFrm.tpcRegistro.idCaracteristica != null ? tipoProductoFrm.tpcRegistro.idCaracteristica.nombre : ''}"
                                             disabled="true" style="min-width:420px"/>
                                <p:commandButton value="Seleccionar" styleClass="btn-oscuro"
                                                 actionListener="#{tipoProductoFrm.tpcSeleccionarAbrirDialogo}"
                                                 process="@this" update=":dlgBuscarCar"
                                                 style="margin-left:8px"/>
                            </h:panelGroup>

                            <h:outputLabel for="chkObl" value="Obligatorio:"/>
                            <h:selectBooleanCheckbox id="chkObl" value="#{tipoProductoFrm.tpcRegistro.obligatorio}"/>

                            <h:outputLabel for="txtFec" value="Fecha de Creación:"/>
                            <h:inputText id="txtFec" value="#{tipoProductoFrm.tpcFechaCreacionTexto}" disabled="true"/>

                            <!-- 👉 Guardar dentro del mismo panel y con rendered -->
                            <h:outputText />
                            <p:commandButton value="Guardar Característica" styleClass="btn-rojo"
                                             actionListener="#{tipoProductoFrm.tpcGuardar}"
                                             process=":frmCrear"
                                             disabled="#{empty tipoProductoFrm.tpcRegistro.idCaracteristica}"
                                             update=":messages :pnlDetalle :pnlTabla"/>



                        </h:panelGrid>

                    </p:panelGrid>
                </p:tab>


            </p:tabView>
        </h:form>
    </h:panelGroup>

    <!-- Diálogo de búsqueda/selección de Característica -->
    <p:dialog id="dlgBuscarCar" widgetVar="dlgBuscarCarWV" header="Seleccionar característica"
              modal="true" resizable="false" width="680"
              visible="#{tipoProductoFrm.dlgBuscarVisible}">
        <h:form id="frmDlgCar">
            <p:panelGrid columns="3" styleClass="form-grid-2col" columnClasses="col-label,col-field,col-field">
                <h:outputLabel for="txtFiltro" value="Buscar:"/>
                <h:inputText id="txtFiltro" value="#{tipoProductoFrm.filtroCaracteristica}" styleClass="inp"/>
                <p:commandButton value="Buscar" styleClass="btn-oscuro"
                                 actionListener="#{tipoProductoFrm.tpcBuscarCaracteristicas}"
                                 update="tblRes"/>
            </p:panelGrid>

            <p:dataTable id="tblRes"
                         value="#{tipoProductoFrm.resultadosBusqueda}"
                         var="c" paginator="true" rows="8"
                         emptyMessage="Sin resultados">
                <p:column headerText="ID" style="width:80px"><h:outputText value="#{c.id}" /></p:column>
                <p:column headerText="Nombre"><h:outputText value="#{c.nombre}" /></p:column>
                <p:column headerText="Unidad medida"><h:outputText value="#{c.idTipoUnidadMedida != null ? c.idTipoUnidadMedida.nombre : '-'}" /></p:column>
                <p:column style="width:130px">
                    <p:commandButton value="Elegir" styleClass="btn-rojo"
                                     actionListener="#{tipoProductoFrm.tpcSeleccionarCaracteristica(c)}"
                                     update=":pnlDetalle"
                                     oncomplete="PF('dlgBuscarCarWV').hide();"/>
                </p:column>
            </p:dataTable>
        </h:form>
    </p:dialog>

</h:body>
</html>
