<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="es"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TipoProductoCaracteristicaFrm.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">InventarioWebAppPRN335</a> &gt; <a href="index.source.html" class="el_package">sv.edu.ues.occ.ingenieria.prn335.inventario.web.boundary.servlet</a> &gt; <span class="el_source">TipoProductoCaracteristicaFrm.java</span></div><h1>TipoProductoCaracteristicaFrm.java</h1><pre class="source lang-java linenums">package sv.edu.ues.occ.ingenieria.prn335.inventario.web.boundary.servlet;

import jakarta.annotation.PostConstruct;
import jakarta.faces.application.FacesMessage;
import jakarta.faces.context.FacesContext;
import jakarta.faces.event.ActionEvent;
import jakarta.faces.view.ViewScoped;
import jakarta.inject.Inject;
import jakarta.inject.Named;

import java.io.Serializable;
import java.time.OffsetDateTime;
import java.util.List;
import java.util.Objects;
import java.util.logging.Level;
import java.util.logging.Logger;

import sv.edu.ues.occ.ingenieria.prn335.inventario.web.control.InventarioDefaultDataAccess;
import sv.edu.ues.occ.ingenieria.prn335.inventario.web.control.TipoProductoCaracteristicaDAO;
import sv.edu.ues.occ.ingenieria.prn335.inventario.web.core.entity.Caracteristica;
import sv.edu.ues.occ.ingenieria.prn335.inventario.web.core.entity.TipoProducto;
import sv.edu.ues.occ.ingenieria.prn335.inventario.web.core.entity.TipoProductoCaracteristica;

/**
 * Managed Bean para administrar la relación TipoProducto-Caracteristica.
 * Hereda el comportamiento base de DefaultFrm&lt;T&gt;.
 */
@Named(&quot;tipoProductoCaracteristicaFrm&quot;)
@ViewScoped
<span class="nc" id="L30">public class TipoProductoCaracteristicaFrm extends DefaultFrm&lt;TipoProductoCaracteristica&gt; implements Serializable {</span>

<span class="nc" id="L32">    private static final Logger LOG = Logger.getLogger(TipoProductoCaracteristicaFrm.class.getName());</span>

    /* =======================
       Inyecciones de DAO
       ======================= */
    @Inject
    private TipoProductoCaracteristicaDAO tpcDao;

    // Si ya tienes estos DAO, inyéctalos; si no, puedes crearlos siguiendo tu base abstracta.
    @Inject
    private sv.edu.ues.occ.ingenieria.prn335.inventario.web.control.TipoProductoDAO tipoProductoDao;

    @Inject
    private sv.edu.ues.occ.ingenieria.prn335.inventario.web.control.CaracteristicaDAO caracteristicaDao;

    /* =======================
       Campos de UI / selección
       ======================= */
    private Long selectedTipoProductoId;
    private Long selectedCaracteristicaId;

    private List&lt;TipoProducto&gt; listaTipoProducto;
    private List&lt;Caracteristica&gt; listaCaracteristica;

    @PostConstruct
    @Override
    public void inicializar() {
<span class="nc" id="L59">        this.nombreBean = &quot;TipoProducto-Característica&quot;;</span>
<span class="nc" id="L60">        super.inicializar(); // inicializa LazyDataModel</span>
<span class="nc" id="L61">        cargarCombos();</span>
<span class="nc" id="L62">    }</span>

    private void cargarCombos() {
        try {
<span class="nc bnc" id="L66" title="All 2 branches missed.">            this.listaTipoProducto   = tipoProductoDao != null ? tipoProductoDao.findAll() : List.of();</span>
<span class="nc bnc" id="L67" title="All 2 branches missed.">            this.listaCaracteristica = caracteristicaDao != null ? caracteristicaDao.findAll() : List.of();</span>
<span class="nc" id="L68">        } catch (Exception e) {</span>
<span class="nc" id="L69">            LOG.log(Level.SEVERE, &quot;Error cargando combos&quot;, e);</span>
<span class="nc" id="L70">            getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR,</span>
                    &quot;Error&quot;, &quot;No fue posible cargar listas para selección&quot;));
<span class="nc" id="L72">        }</span>
<span class="nc" id="L73">    }</span>

    /* =======================
       Implementación abstracta
       ======================= */

    @Override
    protected FacesContext getFacesContext() {
<span class="nc" id="L81">        return FacesContext.getCurrentInstance();</span>
    }

    @Override
    protected InventarioDefaultDataAccess&lt;TipoProductoCaracteristica&gt; getDao() {
<span class="nc" id="L86">        return tpcDao;</span>
    }

    @Override
    protected TipoProductoCaracteristica nuevoRegistro() {
<span class="nc" id="L91">        TipoProductoCaracteristica t = new TipoProductoCaracteristica();</span>
<span class="nc" id="L92">        t.setFechaCreacion(OffsetDateTime.now());</span>
<span class="nc" id="L93">        t.setObligatorio(Boolean.FALSE);</span>
        // al crear, limpia selección
<span class="nc" id="L95">        selectedTipoProductoId = null;</span>
<span class="nc" id="L96">        selectedCaracteristicaId = null;</span>
<span class="nc" id="L97">        return t;</span>
    }

    @Override
    protected TipoProductoCaracteristica buscarRegistroPorId(Object id) {
<span class="nc bnc" id="L102" title="All 2 branches missed.">        if (id == null) return null;</span>
        try {
<span class="nc bnc" id="L104" title="All 2 branches missed.">            Long lid = (id instanceof Long) ? (Long) id : Long.valueOf(String.valueOf(id));</span>
            // usamos el EM del DAO concreto
<span class="nc" id="L106">            return tpcDao.getEntityManager().find(TipoProductoCaracteristica.class, lid);</span>
<span class="nc" id="L107">        } catch (Exception e) {</span>
<span class="nc" id="L108">            LOG.log(Level.SEVERE, &quot;Error en buscarRegistroPorId&quot;, e);</span>
<span class="nc" id="L109">            return null;</span>
        }
    }

    @Override
    protected String getIdAsText(TipoProductoCaracteristica r) {
<span class="nc bnc" id="L115" title="All 4 branches missed.">        return (r != null &amp;&amp; r.getId() != null) ? String.valueOf(r.getId()) : null;</span>
    }

    @Override
    protected TipoProductoCaracteristica getIdByText(String id) {
<span class="nc bnc" id="L120" title="All 2 branches missed.">        if (id == null) return null;</span>
<span class="nc" id="L121">        return buscarRegistroPorId(id);</span>
    }

    /* =======================
       Botones / Handlers
       ======================= */

    /** Sobrescribimos para poblar selección al EDITAR (cuando el usuario selecciona una fila). */
    @Override
    public void selectionHandler(org.primefaces.event.SelectEvent&lt;TipoProductoCaracteristica&gt; evt) {
<span class="nc" id="L131">        super.selectionHandler(evt);</span>
<span class="nc bnc" id="L132" title="All 2 branches missed.">        if (this.registro != null) {</span>
            try {
<span class="nc" id="L134">                this.selectedTipoProductoId =</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                        (this.registro.getIdTipoProducto() != null) ? this.registro.getIdTipoProducto().getId() : null;</span>
<span class="nc" id="L136">                this.selectedCaracteristicaId =</span>
<span class="nc bnc" id="L137" title="All 2 branches missed.">                        Long.valueOf((this.registro.getIdCaracteristica() != null) ? this.registro.getIdCaracteristica().getId() : null);</span>
<span class="nc" id="L138">            } catch (Exception ex) {</span>
<span class="nc" id="L139">                LOG.log(Level.FINE, &quot;No se pudo sincronizar IDs seleccionados&quot;, ex);</span>
<span class="nc" id="L140">            }</span>
        }
<span class="nc" id="L142">    }</span>

    /**
     * Importante: tu DefaultFrm valida &quot;getNombre()&quot;, pero esta entidad no tiene nombre.
     * Por eso, sobrescribimos el guardar para validar (tipoProducto, caracteristica) y &quot;obligatorio&quot;.
     */
    @Override
    public void btnGuardarHandler(ActionEvent actionEvent) {
<span class="nc bnc" id="L150" title="All 2 branches missed.">        if (this.registro == null) {</span>
<span class="nc" id="L151">            getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN,</span>
                    &quot;Atención&quot;, &quot;No hay registro para guardar&quot;));
<span class="nc" id="L153">            return;</span>
        }
        try {
            // Validaciones mínimas
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (selectedTipoProductoId == null) {</span>
<span class="nc" id="L158">                getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN,</span>
                        &quot;Atención&quot;, &quot;Debe seleccionar un Tipo de Producto&quot;));
<span class="nc" id="L160">                return;</span>
            }
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (selectedCaracteristicaId == null) {</span>
<span class="nc" id="L163">                getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN,</span>
                        &quot;Atención&quot;, &quot;Debe seleccionar una Característica&quot;));
<span class="nc" id="L165">                return;</span>
            }

            // Armar relaciones
<span class="nc" id="L169">            TipoProducto tp = tipoProductoDao.getEntityManager().find(TipoProducto.class, selectedTipoProductoId);</span>
<span class="nc" id="L170">            Caracteristica ca = caracteristicaDao.getEntityManager().find(Caracteristica.class, selectedCaracteristicaId);</span>
<span class="nc bnc" id="L171" title="All 4 branches missed.">            if (tp == null || ca == null) {</span>
<span class="nc" id="L172">                getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR,</span>
                        &quot;Error&quot;, &quot;No se pudo encontrar el Tipo de Producto o la Característica seleccionados&quot;));
<span class="nc" id="L174">                return;</span>
            }
<span class="nc" id="L176">            this.registro.setIdTipoProducto(tp);</span>
<span class="nc" id="L177">            this.registro.setIdCaracteristica(ca);</span>

            // Evitar duplicados (tipoProducto, caracteristica)
<span class="nc" id="L180">            boolean exists = tpcDao.existsByTipoProductoAndCaracteristica(selectedTipoProductoId, selectedCaracteristicaId);</span>
<span class="nc bnc" id="L181" title="All 4 branches missed.">            if (exists &amp;&amp; (this.registro.getId() == null)) {</span>
<span class="nc" id="L182">                getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_WARN,</span>
                        &quot;Duplicado&quot;, &quot;Ya existe esta combinación de Tipo de Producto y Característica&quot;));
<span class="nc" id="L184">                return;</span>
            }

            // Crear (si no hay ID) o Modificar (si ya tiene ID)
<span class="nc bnc" id="L188" title="All 2 branches missed.">            if (this.registro.getId() == null) {</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                if (this.registro.getFechaCreacion() == null) {</span>
<span class="nc" id="L190">                    this.registro.setFechaCreacion(OffsetDateTime.now());</span>
                }
<span class="nc" id="L192">                tpcDao.crear(this.registro);</span>
<span class="nc" id="L193">                getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO,</span>
                        &quot;Éxito&quot;, &quot;Registro creado correctamente&quot;));
            } else {
<span class="nc" id="L196">                tpcDao.modificar(this.registro);</span>
<span class="nc" id="L197">                getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_INFO,</span>
                        &quot;Éxito&quot;, &quot;Registro modificado correctamente&quot;));
            }

            // Reset UI
<span class="nc" id="L202">            this.registro = null;</span>
<span class="nc" id="L203">            this.estado = ESTADO_CRUD.NADA;</span>
<span class="nc" id="L204">            this.modelo = null;</span>
<span class="nc" id="L205">            inicializarRegistros();</span>

<span class="nc" id="L207">        } catch (Exception e) {</span>
<span class="nc" id="L208">            LOG.log(Level.SEVERE, &quot;Error al guardar&quot;, e);</span>
<span class="nc" id="L209">            getFacesContext().addMessage(null, new FacesMessage(FacesMessage.SEVERITY_ERROR,</span>
<span class="nc" id="L210">                    &quot;Error al guardar&quot;, e.getMessage()));</span>
<span class="nc" id="L211">        }</span>
<span class="nc" id="L212">    }</span>

    /* =======================
       Getters / Setters para UI
       ======================= */

    public Long getSelectedTipoProductoId() {
<span class="nc" id="L219">        return selectedTipoProductoId;</span>
    }
    public void setSelectedTipoProductoId(Long selectedTipoProductoId) {
<span class="nc" id="L222">        this.selectedTipoProductoId = selectedTipoProductoId;</span>
<span class="nc" id="L223">    }</span>

    public Long getSelectedCaracteristicaId() {
<span class="nc" id="L226">        return selectedCaracteristicaId;</span>
    }
    public void setSelectedCaracteristicaId(Long selectedCaracteristicaId) {
<span class="nc" id="L229">        this.selectedCaracteristicaId = selectedCaracteristicaId;</span>
<span class="nc" id="L230">    }</span>

    public List&lt;TipoProducto&gt; getListaTipoProducto() {
<span class="nc bnc" id="L233" title="All 4 branches missed.">        if (listaTipoProducto == null || listaTipoProducto.isEmpty()) {</span>
<span class="nc" id="L234">            cargarCombos();</span>
        }
<span class="nc" id="L236">        return listaTipoProducto;</span>
    }

    public List&lt;Caracteristica&gt; getListaCaracteristica() {
<span class="nc bnc" id="L240" title="All 4 branches missed.">        if (listaCaracteristica == null || listaCaracteristica.isEmpty()) {</span>
<span class="nc" id="L241">            cargarCombos();</span>
        }
<span class="nc" id="L243">        return listaCaracteristica;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>